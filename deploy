#! /bin/bash

usage()
{
cat << EOF
usage: $0 options

This script deploys code to the elastic beanstalk environment associated with this git branch.

OPTIONS:
   -h      Show this message
EOF
}

GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ $GIT_BRANCH =~ production ]]
then
    echo "You're about to deploy from a production git branch: $GIT_BRANCH are you sure? (yes/no)"
    read CONFIRMATION
    if [[ $CONFIRMATION != yes ]]
    then
        echo "Deployment cancelled."
        exit
    fi
fi


composer install
COMPOSER_STATUS=$?

if [[ $COMPOSER_STATUS -gt 0 ]]
then
    php composer.phar install
    COMPOSER_STATUS=$?
    if [[ $COMPOSER_STATUS -gt 0 ]]
    then
        echo "Unable to update vendors. Make sure one of 'composer install' or 'php composer.phar install' works."
        exit
    fi
fi

echo "Clearing test environment cache."
php app/console --env=test cache:clear

echo "Beginning PHPUnit testing."
bin/phpunit -c app -d memory_limit=2048M --log-json phpunitoutput.json
PHPUNIT_STATUS=$?

if [[ $PHPUNIT_STATUS -ne 0 ]]
then
    echo "Unable to initialize PHPUnit.  Make sure that 'bin/phpunit -c app' works."
    exit
fi

PHPUNIT_OUTPUT=$(<phpunitoutput.json)

if [[ PHPUNIT_OUTPUT =~ fail || PHPUNIT_OUTPUT =~ error ]]
then
    echo "PHPUnit failures or errors detected."
    exit
fi

echo "Please review the test results.  Would you like to continue deployment? (yes/no)"
read CONFIRMATION
if [[ $CONFIRMATION != yes ]]
then
    echo "Deployment cancelled."
    exit
fi

echo "PHPUnit results accepted.  Pushing to origin branch $GIT_BRANCH"
git push origin $GIT_BRANCH
ORIGIN_PUSH_STATUS=$?
if [[ $ORIGIN_PUSH_STATUS -ne 0 ]]
then
    echo "Unable to push to origin branch $GIT_BRANCH:"
    exit
else
    echo "Push to origin branch $GIT_BRANCH successful.  Deploying to Elastic Beanstalk."
    git aws.push
    echo "BOOM!  Deployed!"
fi